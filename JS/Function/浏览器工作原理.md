# 浏览器工作原理

## 一、浏览器的主要功能

浏览器的主要功能是向服务器发送请求，在浏览器窗口中展示你选择的网络资源（资源：一般为HTML文档，可以是PDF、图片、音视频等其他类型），资源的位置由用户使用URI(统一资源标志符)指定

浏览器的用户界面有许多彼此相同的元素，其中包括：

* 输入URI的地址栏
* 前进和后退的按钮
* 书签设置选项
* 刷新、停止加载当前文档的刷新和停止按钮
* 返回主页的主页按钮

## 二、浏览器的高层结构

浏览器的主要组件：

1、用户界面：包括地址栏、前进/后退按钮、书签菜单等

2、浏览器引擎：在用户界面和渲染引擎之间传递指令

3、渲染引擎：负责显示请求的内容，如果请求的内容是HTML，就负责解析HTML和CSS内容，并将解析后的内容现在屏幕上

4、网络：用于网络调用，如http请求。其接口与平台无关，并为所有平台提供底层实现

5、用户界面后端：用于绘制基本的窗口小部件，如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法

6、JavaScript解释器：用于解析和执行JavaScript代码

7、数据存储：持久层，浏览器需要在硬盘上保存各种数据，例如`cookie`。HTML5规范定义了"网络数据库"，这是一个完整但轻便的浏览器内数据库

![浏览器组件](https://user-gold-cdn.xitu.io/2018/10/31/166c94f5421d6ae6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

## 三、渲染引擎

作用：主要用来展示HTML、XML、图片、PDF等资源

### 1、主要流程

渲染引擎一开始会从网络层获取请求文档的内容，内容的大小一般限制在8000个块以内

然后进行如下基本流程：

解析HTML构建DOM树 => 渲染树结构 => 渲染树布局 => 绘制渲染树

![img](https://user-gold-cdn.xitu.io/2018/10/31/166c94f542293012?imageslim)

渲染引擎开始解析HTML文档，并将个标记逐个转化为“内容树”上的DOM节点。同时也会解析外部CSS文件以及样式元素中的样式数据。HTML中这些带有视觉指令的样式信息将用于创建另一个树结构：**渲染树**

渲染树包含多个带有视觉属性（如颜色和尺寸）矩形，这些矩形的排列顺序就是他们在屏幕上显示的顺序。

渲染树构建完毕后，进入布局处理阶段，为每个节点分配一个应出现的屏幕上的确切坐标。

下一个阶段是绘制，渲染引擎会遍历渲染树，由用户界面后端层将每个节点绘制出来。

> 这是一个渐进的过程，为了更好的用户体验，渲染引擎会尽快将内容显示在屏幕上，不必等到整个HTML文档解析完毕之后就会开始构建渲染树和设置布局。在不断接收和处理来自网络的其余内容的同时，渲染引擎会将部分内容解析并显示出来



![WebKit主要流程](https://user-gold-cdn.xitu.io/2018/10/31/166c94f06bc75fcd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

<center>WebKit主要流程</center>



![Gecko主要流程](https://user-gold-cdn.xitu.io/2018/10/31/166c94f06b007c6d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

<center>Gecko主要流程</center>



`WebKit` 和 `Gecko` 渲染的整体流程基本相同。

* Gecko将视觉格式化元素组成的树称为“框架树”，每一个元素都是一个框架。WebKit使用的是“渲染树”，由“渲染对象”组成。
* 对于元素的放置，WebKit使用的术语是“布局”，Gecko使用的是“重排”
* 对于连接DOM节点和可视化信息从而创建渲染树的过程，WebKit使用的术语是“附加”
* Gecko在HTML与DOM树之间存在一个“内容槽”层，用于生成DOM元素



## DOM模型

### 1、DOM标准

DOM（文档对象模型），是可以以一种独立于平台和语言的方式访问和修改一个文档的内容和结构。

如Web开发中，用Javascript来访问、创建、删除或修改HTML的文档结构

### 2、DOM树

DOM中，对文档的表示方法并没有限制，DOM树只是多文档结构中的一种较为普遍的实现方式

文档节点、元素节点、属性节点、Entity节点、注释节点

DOM树以HHTMLDocument为根节点，其余节点为子节点，组织成一个树的数据结构的表示

## HTML解释器

HTML 解释器的工作就是将网络或者本地磁盘获取的 HTML 网页和资源从字节流解释成 DOM 树结构

![img](https://img-blog.csdn.net/2018062900265381)

这个过程中，每一个环节都会调用对应的类去处理

* 词法分析：HTMLTokenizer类
* 词语验证：XSSAuditor类
* 从词语到节点：HTMLDocumentParser类、HTMLTreeBuilder类
* 从节点到DOM树：HTMLConstructionSite类

字符流后的整个解释、布局和渲染过程基本会交给一个单独的渲染线程类管理（不是绝对）。由于DOM树只能在渲染线程上创建和访问，所以构建DOM树的过程只能在渲染线程中进行。

从字符串到词语这个阶段可以交给单独的线程来做，在解释成词语之后，WebKit会分批次将结果词语传递回渲染线程























